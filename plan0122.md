# plan0122.md: script.js 개선 계획

`문제점.md` 파일을 기반으로 `script.js`의 문제점을 분석하고 아래와 같이 개선 계획을 수립합니다.

## 1. 함수 실행 로직 개선

### 문제점
- **스코프 단절**: '개별 실행 모드'에서는 각 코드 라인(세미콜론 기준)이 `new Function`을 통해 완전히 고립된 환경에서 실행됩니다. 이로 인해 한 라인에서 선언한 변수나 함수를 다음 라인에서 참조할 수 없어 REPL과 같은 순차적 코드 실행이 불가능합니다. (e.g., `const a = 1;` 실행 후 `a;`를 실행하면 `a`를 찾지 못하는 오류 발생)
- **불완전한 함수 평가**: 중첩된 화살표 함수(e.g., `() => () => 100`)를 실행했을 때, `resolveFunction`이 의도대로 최종 값까지 재귀적으로 호출하지 못하고 중간 단계의 함수를 반환하는 문제가 있습니다. 사용자는 `return` 키워드 없이도 최종 값(`100`)을 보기를 기대합니다.

### 개선 방안
- **(短期) `executeLine` 및 `resolveFunction` 수정**:
    - `executeLine` 함수에서 `'use strict'` 모드와 `return` 문을 함께 사용할 때 발생하는 구문 오류를 수정하여, 각 라인의 표현식이 올바른 값을 반환하도록 합니다.
    - `resolveFunction`이 중첩 함수를 끝까지 평가할 수 있도록 로직을 재검토하고 수정합니다.
- **(長期) 실행 컨텍스트 공유**: '개별 실행 모드'의 근본적인 해결을 위해, 모든 라인이 하나의 실행 컨텍스트(스코프)를 공유하는 아키텍처 변경을 고려합니다.
    - **대안**: `iframe`의 `contentWindow`나 `Worker`를 사용하여 지속적인 자바스크립트 실행 환경을 만들고, 모든 코드를 해당 환경 내에서 실행하여 스코프를 유지시키는 방법을 도입할 수 있습니다.

## 2. 객체 및 함수 출력 포매팅

### 문제점
- 객체나 함수를 코드 에디터에 입력했을 때, 그 내용이나 최종 실행 결과가 아닌 `[object Object]`나 함수의 소스 코드가 그대로 출력되는 경우가 있습니다.
- 이는 근본적으로 1번의 '함수 실행 로직' 문제로 인해, `formatOutput` 함수에 값이 전달되기 전에 해당 값이 완전히 평가되지 않았기 때문입니다.

### 개선 방안
- **1번 문제 해결과 연동**: '함수 실행 로직 개선' 작업이 선행되면 이 문제는 대부분 자연스럽게 해결됩니다. `resolveFunction`이 함수의 최종 값을 정확히 반환하면, `formatOutput`은 이미 구현된 `JSON.stringify` 등을 통해 객체나 값을 올바르게 문자열로 변환하여 출력할 것입니다.

## 3. Strict Mode 실행 오류 수정

### 문제점
- Strict Mode 체크박스를 켠 상태로 '개별 실행 모드'를 사용하면, 코드가 예상과 다르게 동작하거나 오류가 발생합니다.
- **원인**: 현재 로직은 Strict Mode가 켜져 있으면 **(1)** 전체 코드 상단에 `'use strict';`를 먼저 붙인 후, **(2)** '개별 실행 모드'에서 각 라인을 처리하는 `executeLine` 함수 내에서 또다시 `'use strict';`를 붙이려고 시도합니다. 이 과정에서 로직이 충돌하고, `return 'use strict'; ...` 와 같이 잘못된 코드가 생성되어 구문 오류가 발생합니다.

### 개선 방안
- **`'use strict'` 주입 로직 분리**:
    - `submitButton`의 클릭 이벤트 핸들러 상단에서 무조건 `'use strict';`를 추가하는 로직을 제거합니다.
    - **통합 실행 모드**: `else` 블록 내부에서만 전체 코드 상단에 `'use strict';`를 추가합니다.
    - **개별 실행 모드**: `executeLine` 함수가 단독으로 `'use strict';` 추가를 책임지도록 역할을 명확히 합니다. `code.split` 이전에 원본 `code`가 변경되지 않도록 수정합니다.
- **`executeLine` 버그 수정**: `executeLine` 함수에서 `return` 키워드와 `'use strict'`가 잘못 조합되어 구문 오류를 일으키는 부분을 수정하여, Strict Mode가 각 라인에 올바르게 적용되도록 합니다.

